(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=function(a,b){return function(){return a.apply(b,arguments)}},p={}.hasOwnProperty,q=function(a,b){function c(){this.constructor=a}for(var d in b)p.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},r=[].slice;d="undefined"!=typeof exports&&null!==exports?exports:this.V1||(this.V1={}),n=null==("undefined"!=typeof this&&null!==this?this._:void 0)?function(){if("undefined"!=typeof require&&null!==require)return require("underscore");throw"Unable to load/find underscore"}():this._,b=null==("undefined"!=typeof this&&null!==this?this.Backbone:void 0)?function(){if("undefined"!=typeof require&&null!==require)return require("backbone");throw"Unable to load/find backbone"}():this.Backbone,g=void 0,f=void 0,m={read:function(a,b){var c,d,e;if(c=(null!=(e=this.queryOptions)?e.retriever:void 0)||(null!=b?b.retriever:void 0)||g,null==c)throw"A retriever is required";return d=c.into(a,b).done(b.success).fail(b.error),a.trigger("request",a,d,b),d},create:function(a,b){var c,d,e;if(c=(null!=(e=this.queryOptions)?e.persister:void 0)||(null!=b?b.persister:void 0)||f,null==c)throw"A persister is required";return d=c.create(a,b).fail(b.error).done(b.success),a.trigger("request",a,d,b),d},"delete":function(a,b){var c,d,e;if(c=(null!=(e=this.queryOptions)?e.persister:void 0)||(null!=b?b.persister:void 0)||f,null==c)throw"A persister is required";return d=c["delete"](a,b).fail(b.error).done(b.success),a.trigger("request",a,d,b),d}},l=function(a,b,c){if(!m[a])throw'Unsupported sync method: "'+a+'"';return m[a].call(this,b,c)},j=function(a){return a.prototype.isV1&&a===b.Model||a.prototype instanceof b.Model},i=function(a){return a.prototype.isV1&&a===b.Collection||a.prototype instanceof b.Collection},h=function(a){return j(a)||i(a)},k=function(a){return a.prototype.sync=l,a.prototype.isV1=!0,null!=a.prototype.idAttribute&&(a.prototype.idAttribute="_oid"),a},d.Backbone={setDefaultRetriever:function(a){return g=new d.Backbone.JsonRetriever(a)},clearDefaultRetriever:function(){return g=void 0},setDefaultPersister:function(a){return f=new d.Backbone.RestPersister(a)},clearDefaultPersister:function(){return f=void 0},begin:function(a){return a=n.extend({},null!=g?g.options:void 0,a,{batch:!0}),new d.Backbone.JsonRetriever(a)},mixInTo:k,Model:k(b.Model.extend()),Collection:k(b.Collection.extend())},d.Backbone.JsonRetriever=function(){function b(a){if(this.clear=o(this.clear,this),this.resolveBatch=o(this.resolveBatch,this),null==(null!=a?a.url:void 0))throw"url required";this.options=n.extend({},l,a),this.clear()}var d,e,f,g,k,l,m,p,q,r;return l={fetch:function(){return $.post.apply($,arguments)},defer:function(){return $.Deferred.apply($,arguments)}},r=["find","filter","where","with"],m=function(a,b){var c,f,k,l,m;if(!h(a))throw"Unsupported type";return j(a)&&(f=a.prototype),i(a)&&(f=a.prototype.model.prototype),l=f.queryOptions,c=l.assetType||b,k={from:b?""+b+" as "+c:c},g(l.schema,k),d(a,k),e(a,k),i(a)&&"function"==typeof(m=a.prototype).queryMucker&&m.queryMucker(k),k},f=function(a){var b;return b=m(a.type,a.attribute),n.extend(b,n.pick(a,r))},q=function(a,b){return b=n.isString(b)?[b]:b,n.isArray(b)&&b.length>0&&(a=a.concat(b)),a},d=function(a,b){var c,d,e;return c=[],c=q(c,null!=(d=a.prototype.queryOptions)?d.filter:void 0),i(a)&&(c=q(c,null!=(e=a.prototype.model.prototype.queryOptions)?e.filter:void 0)),c.length>0?b.filter=c:void 0},e=function(a,b){var c,d;return c=[],c=q(c,null!=(d=a.prototype.queryOptions)?d.findIn:void 0),c.length>0?b.findIn=c:void 0},g=function(b,d){if(n.isString(b))return d.select=[b];if(null!=b&&b.length>0)return d.select=n(b).map(function(b){return b instanceof c?f(b):b instanceof a?b.attribute:n.isString(b)?b:void 0})},b.prototype["for"]=function(a){return this.batchInto(a,m(a),this.queries.length).pipe(function(b){return new a(b)})},b.prototype.fetch=function(a,b){return b=n.extend({},b,{retriever:this}),a.fetch(b)},b.prototype.into=function(a,b){var c,d,e,f,g;if(f=a.constructor,e=m(f),n.extend(e,n.pick(b,r)),null!=a.queryMucker&&a.queryMucker!==f.prototype.queryMucker&&"function"==typeof a.queryMucker&&a.queryMucker(e),j(f)){if(!a.id)throw"`id` is required";e.where=n.extend(e.where||{},{ID:a.id})}return this.options.batch?this.batchInto(f,e,this.queries.length):(c=JSON.stringify(e),g=this.options.fetch(this.options.url,c),d=g.pipe(function(a){return p(a[0],f)}),null!=g.abort&&null==d.abort&&(d.abort=n.bind(g.abort,g)),d)},b.prototype.findOrCreateBatch=function(){return null==this.currentBatch&&(this.currentBatch=this.options.defer()),this.currentBatch},b.prototype.batchInto=function(a,b,c){return this.queries[c]=b,this.findOrCreateBatch().pipe(function(b){return p(b[c],a)})},b.prototype.exec=function(){var a;if(this.currentBatch)return a=n(this.queries).map(function(a){return JSON.stringify(a)}).join("\n---\n"),this.options.fetch(this.options.url,a).done(this.resolveBatch)},b.prototype.resolveBatch=function(a){return this.currentBatch.resolve(a),this.clear()},b.prototype.clear=function(){return this.queries=[],this.currentBatch=void 0},p=function(a,b){var c;return c=k(a,b),i(b)?c:j(b)?c[0]:void 0},k=function(b,d){var e,f,g;return e=j(d)?null!=(f=d.prototype.queryOptions)?f.schema:void 0:null!=(g=d.prototype.model.prototype.queryOptions)?g.schema:void 0,n.isString(e)&&(e=[e]),n(b).map(function(b){var d;return d={_oid:b._oid},n(e).each(function(e){var f;if(n.isString(e))return d[e]=b[e];if(e instanceof a){if(!(e instanceof c))return d[e.alias]=b[e.attribute];if(f=k(b[e.attribute],e.type),e.isSingle()&&null!=f[0]&&(d[e.alias]=new e.type(f[0])),e.isMulti())return d[e.alias]=new e.type(f)}}),d})},b}(),d.Backbone.RestPersister=function(){function b(a){if(this.url=o(this.url,this),null==(null!=a?a.url:void 0))throw"url required";this.options=n.extend({},d,a)}var d,e;return e=n.template('<%= baseUrl %>/<%= assetType %><% if(typeof(id) != "undefined") { %>/<%= id %><% } %>'),d={post:function(a,b){return $.ajax({type:"POST",url:a,data:b,dataType:"text"})},defer:function(){return $.Deferred.apply($,arguments)}},b.prototype.url=function(a,b){var c;return c=null!=b?b.split(":"):[],e({baseUrl:this.options.url,assetType:c[0]||a,id:c[1]})},b.prototype["delete"]=function(a,b){var c;if(!j(a.constructor))throw"Unsupported context";return b=b||{},c=b.attrs||a.toJSON(b),this.options.post(this.url(a.queryOptions.assetType,a.id)+"?op=Delete")},b.prototype.create=function(b,d){var e,f,g,h,i;if(!j(b.constructor))throw"Unsupported context";return d=d||{},f=d.attrs||b.toJSON(d),h=function(a,b){var c;return c=f[b],null!=c?'<Attribute name="'+n.escape(a)+'" act="set">'+n.escape(f[b])+"</Attribute>":void 0},i=function(a){var b,c;return c=f[a.alias],null!=c?(b=c.id,'<Relation name="'+n.escape(a.attribute)+'" act="set"><Asset idref="'+n.escape(b)+'" /></Relation>'):void 0},g=n(b.queryOptions.schema).chain().map(function(b){if(b instanceof c&&b.isSingle())return i(b);if(!(b instanceof c))return b instanceof a?h(b.attribute,b.alias):n.isString(b)?h(b,b):void 0}).value().join(""),e="<Asset>"+g+"</Asset>",this.options.post(this.url(b.queryOptions.assetType,b.id),e).done(function(a){var c;return(c=/id="(\w+:\d+):\d+"/.exec(a))?b.id=c[1]:void 0})},b}(),e=function(a,b){var c;return c=function(){},c.prototype=a,n(new c).tap(b||function(){})},e.extend=function(a,b){return e(a,function(a){return n.extend(a,b)})},e.add=function(a,b,c){return e(a,function(d){return d[b]=n.isArray(a[b])?a[b].concat(c):c})},e.merge=function(a,b){return e(a,function(){return n(b).each(function(b,c){return a[c]=n.extend(b,a[c])})})},a=function(){function a(a){this.attribute=a,this.alias=this.attribute}return a.prototype.as=function(a){return e.extend(this,{alias:a})},a}(),d.Backbone.alias=function(b){return new a(b)},c=function(a){function b(a){this.attribute=a,b.__super__.constructor.call(this,this.attribute),this.type=d.Backbone.Collection}return q(b,a),b.prototype.isMulti=function(){return i(this.type)},b.prototype.isSingle=function(){return j(this.type)},b.prototype.of=function(a){if(!h(a))throw"Unsupported type must be a V1.Backbone.Model or a V1.Backbone.Collection";return e.extend(this,{type:a})},b.prototype.addFilter=function(){var a;return a=1<=arguments.length?r.call(arguments,0):[],e.add(this,"filter",a)},b.prototype.addWhere=function(a){return e.merge(this,{where:a})},b.prototype.addWith=function(a){return e.merge(this,{newWith:a})},b}(a),d.Backbone.relation=function(a){return new c(a)}}).call(this);