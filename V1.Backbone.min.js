(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=function(a,b){return function(){return a.apply(b,arguments)}},p={}.hasOwnProperty,q=function(a,b){function c(){this.constructor=a}for(var d in b)p.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},r=[].slice;d="undefined"!=typeof exports&&null!==exports?exports:this.V1||(this.V1={}),n=null==("undefined"!=typeof this&&null!==this?this._:void 0)?function(){if("undefined"!=typeof require&&null!==require)return require("underscore");throw new Error("Unable to load/find underscore")}():this._,b=null==("undefined"!=typeof this&&null!==this?this.Backbone:void 0)?function(){if("undefined"!=typeof require&&null!==require)return require("backbone");throw new Error("Unable to load/find backbone")}():this.Backbone,f=function(a,b){var c;return c=function(){var c,d,e;for(d=0,e=arguments.length;e>d;d++)if(c=arguments[d],null!=(null!=c?c[a]:void 0))return c[a];return b},n(c).tap(function(c){return c.safe=function(){var b;if(b=c.apply(this,arguments),null==b)throw new Error("A "+a+" is required");return b},c.set=function(a){return b=a}})},h=f("retriever"),g=f("persister"),m=function(){var a;return a=function(){var a,b;return b=function(a){return function(b,c){var d,e;return d=g.safe(this.queryOptions,c),e=d[a](b,c).fail(c.error).done(c.success),b.trigger("request",b,e,c),e}},a=function(a,b){var c,d;return c=h.safe(this.queryOptions,b),d=c.into(a,b).done(b.success).fail(b.error),a.trigger("request",a,d,b),d},{read:a,create:b("send"),update:b("send"),"delete":b("delete")}}(),function(b,c,d){if(!a[b])throw new Error('Unsupported sync method: "'+b+'"');return a[b].call(this,c,d)}}(),k=function(a){return a.prototype.isV1&&(a===b.Model||a.prototype instanceof b.Model)},j=function(a){return a.prototype.isV1&&(a===b.Collection||a.prototype instanceof b.Collection)},i=function(a){return k(a)||j(a)},l=function(a){return n(a).tap(function(a){return a.prototype.sync=m,a.prototype.isV1=!0,null!=a.prototype.idAttribute?a.prototype.idAttribute="_oid":void 0})},d.Backbone={setDefaultRetriever:function(a){return h.set(new d.Backbone.JsonRetriever(a))},clearDefaultRetriever:function(){return h.set(void 0)},setDefaultPersister:function(a){return g.set(new d.Backbone.RestPersister(a))},clearDefaultPersister:function(){return g.set(void 0)},begin:function(a){var b;return a=n.extend({},null!=(b=h())?b.options:void 0,a,{batch:!0}),new d.Backbone.JsonRetriever(a)},mixInTo:l,Model:l(b.Model.extend()),Collection:l(b.Collection.extend())},d.Backbone.JsonRetriever=function(){function b(a){if(this.clear=o(this.clear,this),this.resolveBatch=o(this.resolveBatch,this),null==(null!=a?a.url:void 0))throw new Error("url required");this.options=n.extend({},p,a),this.clear()}var d,e,f,g,h,l,m,p,q,r,s,t;return p={fetch:function(){return $.post.apply($,arguments)},defer:function(){return $.Deferred.apply($,arguments)}},t=["find","filter","where","with"],q=function(a,b){var c,f,m,n,o;if(!i(a))throw new Error("Unsupported type");return k(a)&&(f=a.prototype),j(a)&&(f=a.prototype.model.prototype),n=f.queryOptions,c=n.assetType||b,m={from:b?""+b+" as "+c:c},j(a)&&null!=a.prototype.queryOptions&&h(a.prototype.queryOptions.sort,m),g(n.schema,m),d(a,m),l(a,m),e(a,m),j(a)&&"function"==typeof(o=a.prototype).queryMucker&&o.queryMucker(m),m},f=function(a){var b;return b=q(a.type,a.attribute),n.extend(b,n.pick(a,t))},s=function(a,b){return b=n.isString(b)?[b]:b,n.isArray(b)&&b.length>0&&(a=a.concat(b)),a},h=function(a,b){return null!=a?b.sort=a:void 0},d=function(a,b){var c,d,e;return c=[],c=s(c,null!=(d=a.prototype.queryOptions)?d.filter:void 0),j(a)&&(c=s(c,null!=(e=a.prototype.model.prototype.queryOptions)?e.filter:void 0)),c.length>0?b.filter=c:void 0},e=function(a,b){var c,d;return c=[],c=s(c,null!=(d=a.prototype.queryOptions)?d.findIn:void 0),c.length>0?b.findIn=c:void 0},l=function(a,b){var c,d;return c=null!=(d=a.prototype.queryOptions)?d["with"]:void 0,null!=b["with"]?b["with"]:b["with"]=c},g=function(b,d){if(n.isString(b))return d.select=[b];if(null!=b&&b.length>0)return d.select=n(b).map(function(b){return b instanceof c?f(b):b instanceof a?b.attribute:n.isString(b)?b:void 0})},b.prototype["for"]=function(a){return this.batchInto(a,q(a),this.queries.length).then(function(b){return new a(b)})},b.prototype.fetch=function(a,b){return b=n.extend({},b,{retriever:this}),a.fetch(b)},b.prototype.into=function(a,b){var c,d,e,f,g;if(f=a.constructor,e=q(f),n.extend(e,n.pick(b,t)),null!=a.queryMucker&&a.queryMucker!==f.prototype.queryMucker&&"function"==typeof a.queryMucker&&a.queryMucker(e),k(f)){if(!a.id)throw new Error("`id` is required");e.where=n.extend(e.where||{},{ID:a.id})}return this.options.batch?this.batchInto(f,e,this.queries.length):(c=JSON.stringify(e),g=this.options.fetch(this.options.url,c),d=g.then(function(a){return r(a[0],f)}),null!=g.abort&&null==d.abort&&(d.abort=n.bind(g.abort,g)),d)},b.prototype.findOrCreateBatch=function(){return null==this.currentBatch&&(this.currentBatch=this.options.defer()),this.currentBatch},b.prototype.batchInto=function(a,b,c){return this.queries[c]=b,this.findOrCreateBatch().then(function(b){return r(b[c],a)})},b.prototype.exec=function(){var a;if(this.currentBatch)return a=n(this.queries).map(function(a){return JSON.stringify(a)}).join("\n---\n"),this.options.fetch(this.options.url,a).done(this.resolveBatch)},b.prototype.resolveBatch=function(a){return this.currentBatch.resolve(a),this.clear()},b.prototype.clear=function(){return this.queries=[],this.currentBatch=void 0},r=function(a,b){var c;return c=m(a,b),j(b)?c:k(b)?c[0]:void 0},m=function(b,d){var e,f,g;return e=k(d)?null!=(f=d.prototype.queryOptions)?f.schema:void 0:null!=(g=d.prototype.model.prototype.queryOptions)?g.schema:void 0,n.isString(e)&&(e=[e]),n(b).map(function(b){var d;return d={_oid:b._oid},n(e).each(function(e){var f;if(n.isString(e))return d[e]=b[e];if(e instanceof a){if(!(e instanceof c))return d[e.alias]=b[e.attribute];if(f=m(b[e.attribute],e.type),e.isSingle()&&null!=f[0]&&(d[e.alias]=new e.type(f[0])),e.isMulti())return d[e.alias]=new e.type(f)}}),d})},b}(),d.Backbone.RestPersister=function(){function b(a){if(this.url=o(this.url,this),null==(null!=a?a.url:void 0))throw new Error("url required");this.options=n.extend({},d,a)}var d,e,f,g;return g=n.template('<%= baseUrl %>/<%= assetType %><% if(typeof(id) != "undefined") { %>/<%= id %><% } %>'),e=function(a,b){return'<Attribute name="'+n.escape(a)+'" act="set">'+n.escape(b)+"</Attribute>"},f=function(a,b){return'<Relation name="'+n.escape(a)+'" act="set"><Asset idref="'+n.escape(b)+'" /></Relation>'},d={post:function(a,b){return $.ajax({type:"POST",url:a,data:b,dataType:"text"})}},b.prototype.url=function(a,b){var c;return c=null!=b?b.split(":"):[],g({baseUrl:this.options.url,assetType:c[0]||a,id:c[1]})},b.prototype["delete"]=function(a,b){var c;if(!k(a.constructor))throw new Error("Unsupported context");return b=b||{},c=b.attrs||a.toJSON(b),this.options.post(this.url(a.queryOptions.assetType,a.id)+"?op=Delete")},b.prototype.send=function(a,b){var c;return c=b.patch===!0?this.sendPatch:this.sendAll,c.apply(this,arguments)},b.prototype.sendPatch=function(b,d){var g,h,i,j,k;return i=n.indexBy(b.queryOptions.schema,function(b){return b instanceof a?b.alias:b}),j=function(b,d){var g;return g=i[d]||d,g instanceof c&&g.isSingle()&&null!=attr[g.alias]?f(g.attribute,attr[g.alias].id):g instanceof c?void 0:g instanceof a?e(g.attribute,b):n.isString(g)?e(g,b):void 0},h=n.map(b.changedAttributes(),j).join(""),g="<Asset>"+h+"</Asset>",k=this.url(b.queryOptions.assetType,b.id),this.options.post(k,g)},b.prototype.sendAll=function(b,d){var g,h,i,j,l;if(!k(b.constructor))throw new Error("Unsupported context");return d=d||{},h=d.attrs||b.toJSON(d),j=function(b){if(b instanceof c&&b.isSingle()&&null!=h[b.alias])return f(b.attribute,h[b.alias].id);if(!(b instanceof c))return b instanceof a?e(b.attribute,h[b.alias]):n.isString(b)?e(b,h[b]):void 0},i=n.map(b.queryOptions.schema,j).join(""),g="<Asset>"+i+"</Asset>",l=this.url(b.queryOptions.assetType,b.id),this.options.post(l,g).done(function(a){var c;return(c=/id="(\w+:\d+):\d+"/.exec(a))?b.id=c[1]:void 0})},b}(),e=function(){var a;return a=function(a,b){var c;return c=function(){},c.prototype=a,n(new c).tap(b||function(){})},n(a).tap(function(a){return a.extend=function(a,b){return e(a,function(a){return n.extend(a,b)})},a.add=function(a,b,c){return e(a,function(d){return d[b]=n.isArray(a[b])?a[b].concat(c):c})},a.merge=function(a,b){return e(a,function(c){return n(b).each(function(b,c){return a[c]=n.extend(b,a[c])})})}})}(),a=function(){function a(a){this.attribute=a,this.alias=this.attribute}return a.prototype.as=function(a){return e.extend(this,{alias:a})},a}(),d.Backbone.alias=function(b){return new a(b)},c=function(a){function b(a){this.attribute=a,b.__super__.constructor.call(this,this.attribute),this.type=d.Backbone.Collection}return q(b,a),b.prototype.isMulti=function(){return j(this.type)},b.prototype.isSingle=function(){return k(this.type)},b.prototype.of=function(a){if(!i(a))throw new Error("Unsupported type must be a V1.Backbone.Model or a V1.Backbone.Collection");return e.extend(this,{type:a})},b.prototype.addFilter=function(){var a;return a=1<=arguments.length?r.call(arguments,0):[],e.add(this,"filter",a)},b.prototype.addWhere=function(a){return e.merge(this,{where:a})},b.prototype.addWith=function(a){return e.merge(this,{newWith:a})},b}(a),d.Backbone.relation=function(a){return new c(a)}}).call(this);